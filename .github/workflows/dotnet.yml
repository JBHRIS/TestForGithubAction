# This workflow will build a .NET project and deploy to Azure VM IIS
name: .NET CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Test
      run: dotnet test --no-build --verbosity normal --configuration Release
      
    - name: Publish
      run: dotnet publish --no-build --configuration Release --output ./publish
      
    - name: Deploy to IIS
      uses: ChristopheLav/iis-deploy@v1
      with:
        website-name: '${{ secrets.AZURE_VM_HOST }}'
        msdeploy-service-url: 'https://20.205.99.114:8172/MSDeploy.axd'
        msdeploy-username: '${{ secrets.AZURE_VM_USERNAME }}'
        msdeploy-password: '${{ secrets.AZURE_VM_PASSWORD }}'
        source-path: './publish'
        skip-extra-files: false
        
    - name: Deployment Summary
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: |
        echo "Deployment completed successfully!"
        echo "Deployed to IIS site: ${{ secrets.AZURE_VM_HOST }}"
        echo "Source path: ./publish"
      shell: powershell
